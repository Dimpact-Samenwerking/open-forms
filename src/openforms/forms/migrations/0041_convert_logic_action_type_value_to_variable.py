# Generated by Django 3.2.15 on 2022-08-12 09:51

from django.db import migrations


def convert_action_type_value_into_variable(apps, _):
    FormLogic = apps.get_model("forms", "FormLogic")
    for rule in FormLogic.objects.iterator():
        has_changes = False
        for action in rule.actions:
            if action["action"]["type"] != "value":
                continue

            has_changes = True
            # both are component keys, so we can simply map them
            action["variable"] = action["component"]
            action["component"] = ""
            action["action"]["type"] = "variable"

        if has_changes:
            rule.save(update_fields=["actions"])


def convert_action_type_variable_into_value(apps, _):
    FormLogic = apps.get_model("forms", "FormLogic")
    for rule in FormLogic.objects.iterator():
        component_keys = rule.form.formvariable_set.filter(
            source="component"
        ).values_list("key", flat=True)
        has_changes = False
        for action in rule.actions:
            if action["action"]["type"] != "variable":
                continue

            if (variable_key := action["variable"]) not in component_keys:
                continue

            has_changes = True
            action["component"] = variable_key
            action["variable"] = ""
            action["action"]["type"] = "value"

        if has_changes:
            rule.save(update_fields=["actions"])


class Migration(migrations.Migration):

    dependencies = [
        ("forms", "0040_set_number_of_formio_components"),
    ]

    operations = [
        migrations.RunPython(
            convert_action_type_value_into_variable,
            convert_action_type_variable_into_value,
        ),
    ]
