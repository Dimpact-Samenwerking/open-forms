# Generated by Django 3.2.20 on 2023-07-31 14:10

from django.db import migrations
from django.db.models import Case, Value, When

IDENTIFIER_MAP = {
    "openforms.appointments.contrib.jcc.models.JccConfig": "jcc",
    "openforms.appointments.contrib.qmatic.models.QmaticConfig": "qmatic",
}
IDENTIFIER_MAP_REVERSE = {v: k for k, v in IDENTIFIER_MAP.items()}


class IdentifierUpdater:
    def __init__(self, mapping: dict[str, str]):
        self.mapping = mapping

    def __call__(self, apps, _):
        AppointmentsConfig = apps.get_model("appointments", "AppointmentsConfig")
        whens = [
            When(plugin=Value(old), then=Value(new))
            for old, new in self.mapping.items()
        ]
        AppointmentsConfig.objects.update(plugin=Case(*whens, default=Value("")))


class Migration(migrations.Migration):

    dependencies = [
        ("appointments", "0011_auto_20230721_1700"),
    ]

    operations = [
        migrations.RunPython(
            IdentifierUpdater(IDENTIFIER_MAP), IdentifierUpdater(IDENTIFIER_MAP_REVERSE)
        ),
    ]
