import {ArgsTable, Canvas, Meta, Story} from '@storybook/addon-docs';

import {FeatureFlagsContext, FormContext} from './Context';
import {FormLogic} from './FormLogic';
import {mockLanguageInfoGet, mockServiceFetchConfigurationsGet, mockServicesGet} from './mocks';

<Meta
  title="Form design/FormLogic"
  component={FormLogic}
  decorators={[
    Story => (
      <FeatureFlagsContext.Provider value={{of_service_fetch_enabled: true}}>
        <FormContext.Provider
          value={{
            staticVariables: [],
            formVariables: [
              {
                dataFormat: '',
                dataType: 'boolean',
                form: 'http://localhost:8000/api/v2/forms/ae26e20c-f059-4fdf-bb82-afc377869bb5',
                formDefinition: null,
                initialValue: true,
                isSensitiveData: false,
                key: 'foo',
                name: 'foo',
                prefillAttribute: '',
                prefillPlugin: '',
                source: 'user_defined',
              },
            ],
            formSteps: [{formDefinition: 'foo', internalName: 'foo'}],
          }}
        >
          <Story />
        </FormContext.Provider>
      </FeatureFlagsContext.Provider>
    ),
  ]}
  parameters={{
    msw: {
      handlers: [
        mockServicesGet([
          {
            label: 'Service 1',
            apiRoot: 'http://foo.com/api/v1/',
            apiType: 'ORC',
          },
          {
            label: 'Service 2',
            apiRoot: 'http://bar.com/api/v1/',
            apiType: 'ORC',
          },
        ]),
        mockServiceFetchConfigurationsGet([
          {
            name: 'Foo fetch',
            url: 'http://openforms.dev/service-fetch-configurations/foo',
            service: 'http://foo.com/api/v1/',
            path: '/some-path',
            method: 'GET',
            headers: [['X-Foo', 'foo']],
            queryParams: [['parameter2', ['value1', 'value2']]],
            body: {field1: 'value', field2: 'value2'},
            dataMappingType: 'jq',
            mappingExpression: '.field.nested',
          },
          {
            name: '', // No name supplied, should fall back to "method path (service)"
            url: 'http://openforms.dev/service-fetch-configurations/bar',
            service: 'http://bar.com/api/v1/',
            path: '/some-other-path',
            method: 'POST',
            headers: [['X-Foo', 'bar']],
            queryParams: [
              ['parameter', ['value']],
              ['parameter2', ['value1', 'value2']],
            ],
            body: {field1: 'value', field2: 'value2'},
            dataMappingType: 'JsonLogic',
            mappingExpression: {var: 'field'},
          },
        ]),
      ],
    },
  }}
/>

# FormLogic

The component to manage all server-side logic rules for a given form.

Logic is configured by adding rules. Rules consist of a trigger expression and a collection of
actions to be executed when the trigger evaluates to be truthy. The logic rule has two flavours -
simple and advanced, which determines the UI to build the trigger.

Both variants use JsonLogic expressions under the hood. One or more actions will be taken when the
rule executes (e.g. changing the value of a variable/component).

**Warning**: this component requires the following contexts: `FormLogicContext`,
`FeatureFlagsContext`.

export const Template = ({logicRules, onChange, onDelete, onAdd}) => (
  <FormLogic logicRules={logicRules} onChange={onChange} onDelete={onDelete} onAdd={onAdd} />
);

## Presentation

<Canvas>
  <Story
    name="Default"
    args={{
      logicRules: [
        {
          uuid: 'foo',
          _generatedId: 'foo', // consumers should generate this, as it's used for the React key prop if no uuid exists
          _logicType: 'simple',
          form: '',
          description: '',
          _mayGenerateDescription: true,
          order: 1,
          jsonLogicTrigger: {'': [{var: ''}, null]},
          isAdvanced: false,
          actions: [
            {
              action: {type: 'fetch-from-service', value: ''},
              component: '',
              formStep: null,
              formStepUuid: null,
              variable: 'bar',
            },
          ],
        },
      ],
      onChange: (index, event) => null,
      onDelete: index => null,
      onAdd: () => null,
    }}
  >
    {Template.bind({})}
  </Story>
</Canvas>

### Props

<ArgsTable of={FormLogic} />
